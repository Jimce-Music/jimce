name: Publish Dev OpenAPI docs

on:
    push:
        branches:
            - main
            - dev
            - "**"

permissions:
    contents: write

jobs:
    docs:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - uses: oven-sh/setup-bun@v1

            - name: Install deps
              run: bun install

            - name: Generate openapi.json
              run: bun run ci:gen-openapi-json

            - name: Build Swagger UI
              run: |
                  bunx swagger-ui-dist
                  mkdir swagger
                  cp -r node_modules/swagger-ui-dist/* swagger/
                  cp openapi.json swagger/openapi.json

                  sed -i 's|https://petstore.swagger.io/v2/swagger.json|./openapi.json|' \
                    swagger/swagger-initializer.js

            - name: Publish to gh-pages
              run: |
                  COMMIT_SHA=$(git rev-parse --short HEAD)
                  BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

                  git config user.name "github-actions"
                  git config user.email "github-actions@github.com"

                  git fetch origin gh-pages || true
                  git checkout gh-pages || git checkout --orphan gh-pages

                  mkdir -p commit/$COMMIT_SHA
                  rm -rf commit/$COMMIT_SHA/*
                  cp -r swagger/* commit/$COMMIT_SHA/

                  if [ "$BRANCH_NAME" = "main" ]; then
                    rm -rf latest
                    mkdir latest
                    cp -r swagger/* latest/
                  fi

                  if [ "$BRANCH_NAME" = "dev" ]; then
                    rm -rf latest-dev
                    mkdir latest-dev
                    cp -r swagger/* latest-dev/
                  fi

                  git add commit/$COMMIT_SHA latest latest-dev || true
                  git commit -m "docs: swagger for $COMMIT_SHA ($BRANCH_NAME)" || exit 0
                  git push origin gh-pages

            - name: Cleanup old commits (keep last 30)
              run: |
                  git checkout gh-pages
                  cd commit || exit 0

                  ls -1dt */ | tail -n +31 | xargs -r rm -rf

                  git add .
                  git commit -m "chore: cleanup old docs" || exit 0
                  git push origin gh-pages
